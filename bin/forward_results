#!/bin/bash

arg0="${0##*/}"

test -f  /var/www/creds/web_push || exit

LOCK=/dev/shm/.lck.$arg0

exec 9<>$LOCK

flock -n 9 || exit 2

TS_FILE="$1"
shift

EVENT="$1"
shift

[[ 0 -lt "$web_push_sleep" ]] || web_push_sleep=100

(
  echo rsync -e 'ssh -i /var/www/creds/web_push -p 2122'  "$@"  hsv_timing@www.dd.id.au:Timing_Results/${EVENT}/ 
  rsync -e 'ssh -i /var/www/creds/web_push -p 2122'  "$@"  hsv_timing@www.dd.id.au:Timing_Results/${EVENT}/ &&
   touch -r "$1" "${TS_FILE}"
  sleep $web_push_sleep # Dont run another transfer for lockout time
)&

